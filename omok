import streamlit as st
import numpy as np

# 게임 설정
BOARD_SIZE = 15
EMPTY = 0
BLACK = 1  # 사용자
WHITE = 2  # AI

# 페이지 설정
st.set_page_config(page_title="감성 오목: AI와 한판", layout="centered")

def init_game():
    """게임 상태 초기화"""
    st.session_state.board = np.zeros((BOARD_SIZE, BOARD_SIZE), dtype=int)
    st.session_state.turn = BLACK
    st.session_state.winner = None
    st.session_state.game_over = False

if 'board' not in st.session_state:
    init_game()

def check_win(board, r, c, piece):
    """승리 조건 검사 (5개 연속)"""
    directions = [(0, 1), (1, 0), (1, 1), (1, -1)]
    for dr, dc in directions:
        count = 1
        # 정방향 검사
        nr, nc = r + dr, c + dc
        while 0 <= nr < BOARD_SIZE and 0 <= nc < BOARD_SIZE and board[nr, nc] == piece:
            count += 1
            nr += dr
            nc += dc
        # 역방향 검사
        nr, nc = r - dr, c - dc
        while 0 <= nr < BOARD_SIZE and 0 <= nc < BOARD_SIZE and board[nr, nc] == piece:
            count += 1
            nr -= dr
            nc -= dc
        if count >= 5:
            return True
    return False

def get_ai_move(board):
    """단순 가중치 기반 AI 로직"""
    best_score = -1
    best_move = None
    
    for r in range(BOARD_SIZE):
        for c in range(BOARD_SIZE):
            if board[r, c] == EMPTY:
                # 중앙 가중치 부여
                score = (BOARD_SIZE // 2 - abs(r - BOARD_SIZE // 2)) + \
                        (BOARD_SIZE // 2 - abs(c - BOARD_SIZE // 2))
                
                # 임시로 두어보고 위협/기회 평가 (간략화된 로직)
                if score > best_score:
                    best_score = score
                    best_move = (r, c)
    return best_move

def handle_click(r, c):
    """사용자 클릭 처리"""
    if st.session_state.board[r, c] == EMPTY and not st.session_state.game_over:
        # 사용자 착수
        st.session_state.board[r, c] = BLACK
        if check_win(st.session_state.board, r, c, BLACK):
            st.session_state.winner = "사용자"
            st.session_state.game_over = True
        else:
            # AI 차례
            ai_r, ai_c = get_ai_move(st.session_state.board)
            st.session_state.board[ai_r, ai_c] = WHITE
            if check_win(st.session_state.board, ai_r, ai_c, WHITE):
                st.session_state.winner = "AI"
                st.session_state.game_over = True

# UI 렌더링
st.title("⚪ 오목 AI 대전 ⚫")
st.markdown("""
    <style>
    .stButton>button {
        width: 30px;
        height: 30px;
        padding: 0;
        margin: 0;
        border-radius: 50%;
        border: 1px solid #ddd;
    }
    .board-row {
        display: flex;
        justify-content: center;
    }
    </style>
""", unsafe_allow_html=True)

if st.session_state.winner:
    st.success(f"축하합니다! {st.session_state.winner}가 승리했습니다.")
    if st.button("새 게임 시작"):
        init_game()
        st.rerun()

# 바둑판 출력
for r in range(BOARD_SIZE):
    cols = st.columns([1] * BOARD_SIZE)
    for c in range(BOARD_SIZE):
        val = st.session_state.board[r, c]
        label = ""
        color = "white"
        if val == BLACK:
            label = "⚫"
        elif val == WHITE:
            label = "⚪"
            
        if cols[c].button(label, key=f"btn_{r}_{c}", disabled=st.session_state.game_over or val != EMPTY):
            handle_click(r, c)
            st.rerun()

st.info("검은색(⚫)이 당신입니다. 빈 공간을 클릭하여 돌을 두세요.")
